INCLUDE "inc/constants.inc"

SECTION "game_map", ROMX
tile_map::
	DB $04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$01,$04,$00,$00,$02,$00,$00,$01,$00,$00,$00,$00,$03,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$03,$00,$00,$00,$00,$00,$00,$00,$00,$03,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$02,$00,$00,$00,$00,$00,$03,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$02,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$01,$00,$00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$02,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$02,$00,$00,$00,$00,$03,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$00,$00,$00,$00,$00,$00,$00,$02,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$03,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04, 0,0,0,0,0,0,0,0,0,0,0,0,
tile_map_end::
collision_map::
	DB $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
	DB $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01, 0,0,0,0,0,0,0,0,0,0,0,0,
collision_map_end::

SECTION "game", ROMX
load_game_data::
	; set map_pointer
	ld hl, MAP_POINTER_TILES
	ld de, tile_map
	ld a, d
	ldi [hl], a
	ld a, e
	ldi [hl], a
	ld de, collision_map
	ld a, d
	ldi [hl], a
	ld a, e
	ldi [hl], a

	ld bc, Sprites_end - Sprites_begin
	ld hl, Sprites_begin
	ld de, VRAM_TILES_BACKGROUND + $10
	call ldir
	ld bc, 32*32
	call ld_map_pointer_tiles
	ld de, VRAM_MAP_BG
	call ldir

	call load_player_data

	ret
update_game::
    call update_player

	ret
draw_game::
	call draw_player



	ret
; b = Y-Position, c = X-Position
; return value in a
is_solid::
	rrc b
	rrc b
	rrc b; div by 8
	dec b
	dec b
	rrc c
	rrc c
	rrc c; div by 8
	dec c
	ld a, b
	scf
	ccf
	rla; goes into carry so extra
	rla
	rla
	rla
	rla
	push af

	rla
	and %00011111
	ld d, a

	pop af
	and %11100000
	add a, c
	ld e, a
	call ld_map_pointer_collision
	add hl, de
	ld a, [hl]
	and a, a
	ret

ld_map_pointer_tiles::
	ld hl, MAP_POINTER_TILES
	ldi a, [hl]
	ld c, [hl]
	ld h, a
	ld l, c
	ret

ld_map_pointer_collision::
	ld hl, MAP_POINTER_COLLISION
	ldi a, [hl]
	ld c, [hl]
	ld h, a
	ld l, c
	ret
